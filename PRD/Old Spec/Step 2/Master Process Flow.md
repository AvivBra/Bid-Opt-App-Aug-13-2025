# Step 2 - Validate Portfolios: Master Process Flow

## תנאי כניסה
- Template הועלה בהצלחה
- Bulk הועלה בהצלחה  
- סוג אופטימיזציה נבחר

## תרשים זרימה ראשי

```
[START Step 2]
    ↓
[1. יצירת Virtual Map ראשוני]
    ↓
[2. ניקוי ראשוני של Bulk]
    ↓
[3. השוואת פורטפוליוז]
    ↓
[4. בדיקת תוצאות]
    ├─[אין חסרים/עודפים] → [6. הקפאת Virtual Map]
    ├─[חסרים בלבד] → [5. לולאת השלמה]
    ├─[עודפים בלבד] → [הצגת עודפים] → [6. הקפאת Virtual Map]
    └─[חסרים + עודפים] → [הצגת עודפים] → [5. לולאת השלמה]
         ↓
[5. לולאת השלמת חסרים]
    ├─[5.1 יצירת Completion Template]
    ├─[5.2 העלאה ע"י משתמש]
    ├─[5.3 מיזוג ל-Virtual Map]
    └─[חזרה ל-2 (ניקוי מחדש)]
         ↓
[6. הקפאת Virtual Map + טריגור אוטומטי]
    ↓
[7. התחלת Step 3 אוטומטית]
    ├─[עיבוד נתונים]
    ├─[יצירת קבצי פלט]
    └─[מעבר אוטומטי לטאב Output]
    ↓
[END Step 2 / START Step 3]
```

## עקרון המעגליות בלולאת ההשלמה

**חשוב: התהליך מעגלי** - אחרי כל מיזוג של Completion Template:
1. Virtual Map מתעדכן עם הנתונים החדשים
2. הבאלק מנוקה מחדש (עם רשימת ignored מעודכנת)
3. חוזרים להשוואת פורטפוליוז
4. אם עדיין יש חסרים - חוזרים ללולאה
5. התהליך ממשיך עד שאין חסרים

## תיאור השלבים

### שלב 1: יצירת Virtual Map ראשוני
- קריאת Template File
- זיהוי פורטפוליוז עם "Ignore"
- בניית מבנה נתונים ראשוני

### שלב 2: ניקוי ראשוני של Bulk
- סינון לפי Entity (Keyword/Product Targeting)
- סינון לפי States (כולם enabled)
- הסרת פורטפוליוז מרשימת ignored

### שלב 3: השוואת פורטפוליוז
- השוואה בין Bulk מנוקה ל-Virtual Map
- זיהוי חסרים (בבאלק אך לא ב-VM)
- זיהוי עודפים (ב-VM אך לא בבאלק)

### שלב 4: בדיקת תוצאות וטיפול
- אין בעיות → המשך ישיר
- חסרים → לולאת השלמה
- עודפים → הצגה והעתקה
- שילוב → טיפול בשניהם

### שלב 5: לולאת השלמת חסרים
- יצירת Completion Template
- המתנה למילוי משתמש
- התנהגות כפתור העלאה: הופך ללא פעיל מיד אחרי העלאה מוצלחת, חוזר לפעיל רק אם נמצאו שגיאות או נותרו חסרים
- ולידציה ומיזוג
- חזרה לניקוי והשוואה
- אם מגיעים ל-10 איטרציות: עצירה עם הודעת שגיאה


### שלב 6: הקפאת Virtual Map
- נעילת הנתונים לקריאה בלבד
- יצירת עותק קפוא
- טריגור אוטומטי ל-Step 3

## לוגיקת השוואת פורטפוליוז

| סוג | הגדרה |
|-----|--------|
| **חסרים** | קיימים בבאלק המנוקה, לא בוירטואל מאפ, לא באיגנור |
| **עודפים** | קיימים בוירטואל מאפ, לא בבאלק המנוקה |

## תנאי יציאה
- Virtual Map מלא וקפוא
- Bulk מנוקה
- **אין אפשרות חזרה - התהליך חד-כיווני**
- Step 3 מתחיל אוטומטית

## כללי ניווט ואיפוס

### ניווט בין טאבים
- מעבר בין טאבים הוא **לתצוגה בלבד** - אין שינוי בנתונים
- ניתן לצפות בכל טאב בכל זמן
- הנתונים נשארים קפואים במצבם האחרון

### איפוס התהליך
- **אין אפשרות לתיקון אחורה** - רק איפוס מלא
- איפוס מתבצע רק ב-2 דרכים:
  1. לחיצה על "New Processing" ב-Step 3
  2. **כל שינוי ב-Step 1** (העלאת קובץ חדש/שינוי בחירה)
- איפוס מוחק את כל הנתונים והתהליך מתחיל מחדש



## קבצי איפיון קשורים
- ראה `Step 2 - Documentation and Code References.md` לרשימת כל המסמכים והקוד
- ראה `Step 2 - Examples and Scenarios.md` לדוגמאות ותרחישים מלאים