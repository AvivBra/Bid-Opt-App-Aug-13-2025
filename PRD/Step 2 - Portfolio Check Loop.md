# אפיון שלב בדיקת הפורטפוליוז – Bid & Budget Optimizer

## מטרה
לאמת שהמשתמש מילא את כל שמות הפורטפוליוז הנדרשים בקובץ ה־Template, להסיר פרוטפוליוז שסומנו להתעלמות (Ignore), ולהפיק רשימת חוסרים במידת הצורך.

## קלטים
1. **Bulk File** לאחר ניקוי ראשוני של לשונית "Sponsored Product Campaigns".
2. **Template File** שהמשתמש העלה, עם העמודות:
   - **Portfolio Name** – שם הפורטפוליו.
   - **Base Bid** – ערך הביד או המילה `Ignore`.
   - **Target CPA** – ערך ה־CPA היעד.

עמודת Base Bids היא השדה היחיד שחובה למלא בכל תבנית. Target CPA היא עמודה אופציונלית, ותופיע בתבניות מסוימות בלבד בהתאם לסוג האופטימיזציה.



## שלבי הבדיקה
1. **סינון Ignore**:
   - המערכת מזהה בכל שורה ב־Template שבה בעמודת **Base Bids** הערך הוא `Ignore`.
   - כל שורה כזו נמחקת מה־Template לצורך המשך הבדיקה.
   - ההשוואה לפורטפוליוז תתבצע על ה־Template לאחר הסינון הזה.

2. **השוואת רשימות פורטפוליוז**:
   - המערכת יוצרת רשימה של כל שמות הפורטפוליוז שקיימים ב־Bulk File לאחר הניקוי הראשוני.
   - המערכת יוצרת רשימה של כל שמות הפורטפוליוז שנשארו ב־Template אחרי סינון ה־Ignore.
   - המערכת משווה בין הרשימות:
     - **חסר** – שמות פורטפוליוז שנמצאים ב־Bulk אך לא ב־Template.

### הפקת Completion Template (Step 2 בלבד)
- אם נמצאו חוסרים, המערכת מייצרת Completion Template עם שלוש העמודות:
  Portfolio Name (ממולא מראש), Base Bid (ריק – חובה למילוי), Target CPA (ריק – אופציונלי).
- המשתמש ממלא רק Base Bid ובמידת הצורך Target CPA, ושומר את הקובץ כפי שהוא.
- לאחר כל העלאה, המערכת מבצעת Merge אל Virtual Map פנימי שמרכז את כל הערכים שהושלמו עד כה.

- המערכת מייצרת קובץ עם **אותן 3 עמודות כמו Template הרגיל**
- ההבדל: Portfolio Name ממולא אוטומטית עבור הפורטפוליוז החסרים

### כללי מיזוג Completion Template

#### דריסה והחלפה
- כל פורטפוליו שמופיע ב-Completion Template **דורס לחלוטין** את הערכים הקיימים
- אין שמירה של ערכים ישנים - החלפה מלאה

#### טיפול ב-Ignore
- אם Base Bid="Ignore" ב-Completion Template, הפורטפוליו **נמחק** מה-Virtual Map
- כל השורות של פורטפוליו זה יוסרו מה-Bulk בניקוי הראשוני

#### ולידציות בזמן מיזוג
1. **Base Bid חסר/לא תקין** → חזרה למילוי מחדש
2. **Target CPA לא תקין** → הודעת שגיאה: "Invalid Target CPA value for portfolio: {name}"
3. **Portfolio לא קיים ב-Bulk** → הודעת שגיאה: "Portfolio '{name}' does not exist in Bulk file"

### סיום השלב (תנאי מעבר ל‑Step 3)
- Step 2 מסתיים כאשר ה‑Virtual Map כולל ערך (Base Bid, ובמידת הצורך Target CPA) לכל פורטפוליו שמופיע ב‑Bulk (אחרי סינון Ignore).
- בשלב זה אין יותר חוסרים, וכפתור ההמשך זמין.

## פלטים
- **ללא חוסרים** – מעבר לשלב הבא.
- **עם חוסרים** – קובץ Completion Template להורדה, עם רשימת הפורטפוליוז החסרים בלבד.
- **עם חוסרים ועודפים** – קובץ Completion Template להורדה + רשימת עודפים + כפתור Continue (disabled עד למילוי כל החוסרים).

## תרשים זרימה
```mermaid
flowchart TD
    A[קבלת Template מהמשתמש] --> B[סינון שורות עם Base Bid='Ignore']
    B --> C[השוואת פורטפוליוז Bulk מול Template]
    C --> D{האם יש חוסרים?}
    D -- כן --> E[הפקת Completion Template עם החוסרים]
    E --> F[העלאת Completion Template מתוקן]
    F --> B
    D -- לא --> G[מעבר לשלב הבא]
